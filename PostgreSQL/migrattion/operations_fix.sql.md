```sql
-- +goose Up
ALTER TABLE maintenance_checklist_operation_indexes ADD COLUMN id_component bigint NULL REFERENCES components(id_component);
DROP TABLE operations_to_maintenance_checklists;

CREATE TABLE operations (
    id_operation             bigint     NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    id_operation_template    bigint     NOT NULL REFERENCES operation_templates(id_operation_template),
    id_equipment             bigint     NOT NULL,
	id_maintenance_checklist bigint     NOT NULL,
	is_excluded              bool       NOT NULL DEFAULT false,
    full_text                varchar        NULL,
    work_amount              decimal(9, 3)  NULL,
	id_component 			 bigint 		NULL REFERENCES components(id_component),
	id_work_type             bigint         NULL REFERENCES work_types(id_work_type),
	id_work_performer        bigint         NULL REFERENCES work_performers(id_work_performer),
	id_measurement_unit      bigint         NULL REFERENCES measurement_units(id_measurement_unit),
	UNIQUE(id_operation_template, id_equipment, id_maintenance_checklist, id_component),
    FOREIGN KEY (id_equipment, id_maintenance_checklist) REFERENCES equipment_to_maintenance_checklists(id_equipment, id_maintenance_checklist)
);

CREATE TABLE operation_spare_parts (
    norm_amount             decimal(9, 3) NOT NULL,
	max_amount              decimal(9, 3) NOT NULL,
    id_operation            bigint        NOT NULL REFERENCES operations(id_operation),
	id_spare_part           bigint        NOT NULL REFERENCES spare_parts(id_spare_part),
	PRIMARY KEY (id_operation, id_spare_part)
);
CREATE TABLE operation_machineries (
	amount                 decimal(9, 3) NOT NULL,
    id_operation           bigint        NOT NULL REFERENCES operations(id_operation),
	id_machinery           bigint        NOT NULL REFERENCES machineries(id_machinery),
	PRIMARY KEY (id_operation, id_machinery)
);
-- существующие связи шаблонов операций с МТР и МиМ переделаны в связи "многие ко многим", чтобы устранить риск дублирования связей
ALTER TABLE operation_template_hardcoded_spare_parts 	 RENAME TO operation_templates_to_hardcoded_spare_parts;
ALTER TABLE operation_template_spare_parts           	 RENAME TO operation_templates_to_spare_parts;
ALTER TABLE operation_template_machineries           	 RENAME TO operation_templates_to_machineries;
ALTER TABLE operation_templates_to_hardcoded_spare_parts DROP COLUMN id_operation_template_hardcoded_spare_part;
ALTER TABLE operation_templates_to_spare_parts 			 DROP COLUMN id_operation_template_spare_part;
ALTER TABLE operation_templates_to_machineries 			 DROP COLUMN id_operation_template_machinery;
ALTER TABLE operation_templates_to_hardcoded_spare_parts ADD CONSTRAINT operation_templates_to_hardcoded_spare_parts_pkey PRIMARY KEY (id_operation_template, id_spare_part);
ALTER TABLE operation_templates_to_spare_parts 			 ADD CONSTRAINT operation_templates_to_spare_parts_pkey 		  PRIMARY KEY (id_operation_template, id_spare_part_purpose);
ALTER TABLE operation_templates_to_machineries 			 ADD CONSTRAINT operation_templates_to_machineries_pkey 		  PRIMARY KEY (id_operation_template, id_machinery);
-- +goose Down
ALTER TABLE operation_templates_to_hardcoded_spare_parts DROP CONSTRAINT operation_templates_to_hardcoded_spare_parts_pkey;
ALTER TABLE operation_templates_to_spare_parts 			 DROP CONSTRAINT operation_templates_to_spare_parts_pkey;
ALTER TABLE operation_templates_to_machineries 			 DROP CONSTRAINT operation_templates_to_machineries_pkey;
ALTER TABLE operation_templates_to_hardcoded_spare_parts ADD COLUMN id_operation_template_hardcoded_spare_part 	bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE operation_templates_to_spare_parts 			 ADD COLUMN id_operation_template_spare_part 			bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE operation_templates_to_machineries 			 ADD COLUMN id_operation_template_machinery 			bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE operation_templates_to_hardcoded_spare_parts RENAME TO operation_template_hardcoded_spare_parts;
ALTER TABLE operation_templates_to_spare_parts			 RENAME TO operation_template_spare_parts;
ALTER TABLE operation_templates_to_machineries			 RENAME TO operation_template_machineries;
DROP TABLE operation_spare_parts;
DROP TABLE operation_machineries;
DROP TABLE operations;

CREATE TABLE operations_to_maintenance_checklists (
	id_operation             bigint NOT NULL REFERENCES operation_templates(id_operation_template),
	id_equipment             bigint NOT NULL,
	id_maintenance_checklist bigint NOT NULL,
	is_excluded              bool   NOT NULL DEFAULT false,
	properties               jsonb  NOT NULL DEFAULT '{}'::jsonb,
	PRIMARY KEY (id_operation, id_equipment, id_maintenance_checklist),
	FOREIGN KEY (id_equipment, id_maintenance_checklist) REFERENCES equipment_to_maintenance_checklists(id_equipment, id_maintenance_checklist)
);
ALTER TABLE maintenance_checklist_operation_indexes DROP COLUMN id_component;
```