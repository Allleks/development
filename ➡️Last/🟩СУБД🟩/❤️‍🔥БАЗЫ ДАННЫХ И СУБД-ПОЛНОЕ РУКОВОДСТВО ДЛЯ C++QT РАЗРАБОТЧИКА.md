**База данных (БД)** — это упорядоченный набор структурированной информации или данных, которые обычно хранятся в электронном виде в компьютерной системе.

**СУБД (Система Управления Базами Данных)** — это комплекс программных средств, который управляет базой данных: обеспечивает создание, хранение, обновление, поиск и администрирование данных.

**Распространенные СУБД:**
- **PostgreSQL** — объектно-реляционная СУБД с открытым кодом
- **MySQL** — реляционная СУБД с открытым кодом (принадлежит Oracle)
- **SQL Server** — коммерческая реляционная СУБД от Microsoft
- **SQLite** — встраиваемая реляционная СУБД (библиотека)
---
### Что такое база данных?

**Аналогия: Офисный шкаф с папками** - Представьте большой металлический шкаф с выдвижными ящиками:
- **Шкаф целиком** — это сервер с СУБД
- **Каждый ящик** — это отдельная база данных
- **Папки в ящике** — это таблицы
- **Листы в папке** — это записи (строки)
- **Колонки в таблице** — это графы в формуляре (ФИО, дата, сумма)
```ascii

    ОФИСНЫЙ ШКАФ (Сервер СУБД)
    ┌─────────────────────────────────┐
    │  ╔═══════════════════════════╗  │
    │  ║  Ящик 1: "Бухгалтерия"    ║  │ <- База данных
    │  ║  ┌─────────────────────┐  ║  │
    │  ║  │ Папка "Счета"       │  ║  │ <- Таблица
    │  ║  │ [Иванов][01.01][500]│  ║  │ <- Запись
    │  ║  │ [Петров][02.01][300]│  ║  │
    │  ║  └───────────────────-─┘  ║  │
    │  ╚═══════════════════════════╝  │
    │  ╔═══════════════════════════╗  │
    │  ║  Ящик 2: "Склад"          ║  │
    │  ╚═══════════════════════════╝  │
    └─────────────────────────────────┘
```
### Чем отличаются СУБД?
**SQLite** — как **блокнот в вашем столе**: всегда под рукой, легкий, не требует отдельного хранения. Только вы в него пишете.
**MySQL/PostgreSQL** — как **библиотека с библиотекарем**: много книг, сложная система поиска, могут работать сразу много читателей, нужен отдельный зал (сервер).
**SQL Server** — как **архив с системой безопасности**: всё строго, доступ по пропускам, дорогое оборудование, но очень надежно.
___
### Основные паттерны работы с БД в Qt
#### 1. Подключение к разным СУБД
```cpp
// SQLite - просто файл
QSqlDatabase db = QSqlDatabase::addDatabase("QSQLITE");
db.setDatabaseName("C:/myapp/data.db");
// PostgreSQL - требуется драйвер
db = QSqlDatabase::addDatabase("QPSQL");
db.setHostName("192.168.1.100");
db.setPort(5432);
db.setDatabaseName("mydb");
db.setUserName("user");
db.setPassword("password");
// SQL Server (через ODBC)
db = QSqlDatabase::addDatabase("QODBC");
db.setDatabaseName("DRIVER={SQL Server};SERVER=server_name;DATABASE=mydb;");
```
#### 2. Выполнение запросов
```cpp
// Простой запрос
QSqlQuery query;
if (!query.exec("SELECT id, name FROM users WHERE active = 1")) {
    qDebug() << "Ошибка:" << query.lastError().text();
    return;
}
while (query.next()) {
    int id = query.value(0).toInt();
    QString name = query.value(1).toString();
    qDebug() << id << name;
}
// Подготовленный запрос (защита от SQL-инъекций)
QSqlQuery prepQuery;
prepQuery.prepare("INSERT INTO users (name, age) VALUES (:name, :age)");
prepQuery.bindValue(":name", "Иванов");
prepQuery.bindValue(":age", 30);
prepQuery.exec();
// Транзакции
db.transaction();
QSqlQuery q1, q2;
bool ok = q1.exec("UPDATE accounts SET balance = balance - 100 WHERE id = 1");
ok &= q2.exec("UPDATE accounts SET balance = balance + 100 WHERE id = 2");
if (ok) {
    db.commit();  // Сохраняем изменения
} else {
    db.rollback(); // Откатываем всё обратно
}
```
#### 3. Модель-представление (MVC) в Qt
```cpp
// SQL модель для отображения в таблице
QSqlTableModel *model = new QSqlTableModel;
model->setTable("employees");
model->setFilter("department = 'IT'");
model->setSort(2, Qt::AscendingOrder);
model->select();
// Настраиваем заголовки
model->setHeaderData(0, Qt::Horizontal, "ID");
model->setHeaderData(1, Qt::Horizontal, "Имя");
// Отображаем в TableView
QTableView *view = new QTableView;
view->setModel(model);
view->show();
// Редактирование прямо в таблице
model->setEditStrategy(QSqlTableModel::OnFieldChange);
```
### Сравнение драйверов Qt

|СУБД|Драйвер|Особенности|
|---|---|---|
|SQLite|QSQLITE|Встроенный, всегда доступен|
|PostgreSQL|QPSQL|Требуется сборка с поддержкой PostgreSQL|
|MySQL|QMYSQL|Требуется сборка с поддержкой MySQL|
|SQL Server|QODBC|Через ODBC, медленнее нативных|

## Уровень 3: Для эксперта (внутреннее устройство)

### Архитектура СУБД
```ascii

                    ВЫСОКОУРОВНЕВАЯ АРХИТЕКТУРА СУБД
    ┌──────────────────────────────────────────────────────────┐
    │                    СЕТЕВОЙ ИНТЕРФЕЙС                     │
    │  (TCP/IP, Unix sockets, Shared Memory для локальных)     │
    └─────────────────────────┬────────────────────────────────┘
                              │
    ┌─────────────────────────▼────────────────────────────────┐
    │              ПАРСЕР И ОПТИМИЗАТОР ЗАПРОСОВ               │
    │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
    │  │ Лексический  │  │ Синтаксич.   │  │ Семантич.    │    │
    │  │ анализ       │─▶│ анализ       │─▶│ анализ       │    │
    │  └──────────────┘  └──────────────┘  └──────────────┘    │
    │                    ┌──────────────┐                      │
    │                    │ Планировщик  │                      │
    │                    │ запросов     │                      │
    │                    └──────────────┘                      │
    └─────────────────────────┬────────────────────────────────┘
                              │
    ┌─────────────────────────▼────────────────────────────────┐
    │                МЕНЕДЖЕР ИСПОЛНЕНИЯ                       │
    │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
    │  │ Транзакции   │  │ Блокировки   │  │ Доступ       │    │
    │  │ (ACID)       │  │ (Locks)      │  │ (Privileges) │    │
    │  └──────────────┘  └──────────────┘  └──────────────┘    │
    └─────────────────────────┬────────────────────────────────┘
                              │
    ┌─────────────────────────▼────────────────────────────────┐
    │              МЕНЕДЖЕР БУФЕРОВ И КЭША                     │
    │  (Стратегии замещения: LRU, Clock, и т.д.)               │
    └─────────────────────────┬────────────────────────────────┘
                              │
    ┌─────────────────────────▼────────────────────────────────┐
    │                 МЕНЕДЖЕР ХРАНЕНИЯ                        │
    │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
    │  │ Индексы      │  │ Таблицы      │  │ Журнал       │    │
    │  │ (B-Tree,     │  │ (Heap,       │  │ (WAL - Write │    │
    │  │  Hash, GiST) │  │  Clustered)  │  │  Ahead Log)  │    │
    │  └──────────────┘  └──────────────┘  └──────────────┘    │
    └─────────────────────────┬────────────────────────────────┘
                              │
    ┌─────────────────────────▼────────────────────────────────┐
    │                 ФАЙЛОВАЯ СИСТЕМА ОС                      │
    │  (ext4, NTFS, ... или прямая работа с диском)            │
    └──────────────────────────────────────────────────────────┘
```
___
### Глубокое сравнение СУБД
#### **PostgreSQL** ("Самый умный")
- **Хранение**: MVCC (Multiversion Concurrency Control) — каждая транзакция видит свой "снимок" данных
- **Индексы**: B-tree, Hash, GiST, SP-GiST, GIN, BRIN
- **Транзакции**: Полная поддержка ACID, уровень изоляции Serializable
- **Особенность**: Можно писать функции на Python/Perl/C внутри БД
```cpp
// Пример работы с PostgreSQL в C++
// Использование libpq (нативный C API)
PGconn *conn = PQconnectdb("host=localhost port=5432 dbname=mydb");
// Подготовленный запрос
PGresult *res = PQexecParams(conn,
    "SELECT * FROM users WHERE age > $1 AND city = $2",
    2, NULL, paramValues, NULL, NULL, 0);
```

#### **MySQL** ("Самый быстрый на чтение")
- **Движки**: InnoDB (транзакции), MyISAM (быстрое чтение, нет транзакций)
- **Репликация**: Master-Slave "из коробки"
- **Хранилище**: Кластеризованные индексы в InnoDB

#### **SQL Server** ("Самый корпоративный")
- **Буферный пул**: Расширенный кэш с поддержкой колоночных индексов
- **Query Store**: Мониторинг производительности запросов
- **Integration Services**: ETL-процессы
```sql
-- Специфичный для SQL Server синтаксис
SELECT TOP 10 WITH TIES
    product_name,
    SUM(quantity) OVER(PARTITION BY category_id) as category_total
FROM products
ORDER BY price DESC;
```

#### **SQLite** ("Самый легкий")
- **Типизация**: Динамическая (можно записать строку в INTEGER колонку)
- **Транзакции**: Rollback journal или WAL (Write-Ahead Logging)
- **Блокировки**: Блокировка на уровне всего файла БД

```cpp
// Оптимизация SQLite в Qt
QSqlDatabase db = QSqlDatabase::addDatabase("QSQLITE");
db.setDatabaseName("data.db");
db.open();
// Ускоряем запись
QSqlQuery query;
query.exec("PRAGMA synchronous = OFF");     // Отключаем синхронную запись
query.exec("PRAGMA journal_mode = MEMORY"); // Журнал в памяти
query.exec("PRAGMA cache_size = 10000");    // Увеличиваем кэш
// Массовая вставка
db.transaction();
for (const auto& record : records) {
    // ... вставка
}
db.commit(); // Один раз пишем на диск
```

### Сравнительная таблица для эксперта

|Характеристика|PostgreSQL|MySQL|SQL Server|SQLite|
|---|---|---|---|---|
|**Архитектура**|Процесс-сервер|Процесс-сервер|Процесс-сервер|Встраиваемая|
|**Модель конкурентности**|MVCC|MVCC (InnoDB)|Блокировки + MVCC|Блокировка файла|
|**Типы данных**|Богатейшие|Стандартные|Богатые|Ограниченные|
|**Расширяемость**|Отличная|Ограниченная|Хранимые процедуры|Нет|
|**Репликация**|Физическая/логическая|Master/Slave, Group Replication|AlwaysOn, Replication|Нет|
|**Память**|Shared buffers + ОС|Buffer pool + ОС|Buffer pool + ОС|ОС кэширует файл|
|**Параллельные запросы**|Да (с 9.6)|Ограниченно|Да|Нет|
