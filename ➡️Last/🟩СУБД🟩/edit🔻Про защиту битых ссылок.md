```sql
INSERT INTO [Проемы] (devID) VALUES (999);
```
**Результат:** ОШИБКА!
```text
Msg 547, Level 16, State 0, Line 1
The INSERT statement conflicted with the FOREIGN KEY constraint "FK__Проемы__devID__5B4E756C".
The conflict occurred in database "Doodle_x_Angarsk", table "dbo.Общие параметры", column 'ID'.
```
## Почему так происходит:
```text
┌─────────────────────────────────────────────────────┐
│  Таблица Общие параметры           Таблица Проемы   │
│  ┌─────┐                          ┌─────┐           │
│  │ ID  │                          │devID│           │
│  ├─────┤                          ├─────┤           │
│  │ 1   │                          │ 1   │           │
│  │ 2   │                          │ 1   │           │
│  │ 3   │                          │ 2   │           │
│  │ 4   │                          │ 3   │           │
│  └─────┘                          │ ??? │           │
│                                   └─────┘           │
│                                                     │
│      Пытаемся вставить devID=999                    │
│      ↓                                              │
│  SQL Server проверяет:                              │
│  "Есть ли в Общие параметры ID=999?"                │
│                                          ▼          │
│  Результат: НЕТ! → ОШИБКА! ⛔                       │
└─────────────────────────────────────────────────────┘
```
## Метафора для понимания:
Представь, что таблицы - это два документа:
```text
┌─────────────────────────────────────────────────────┐
│  Документ "Общие параметры" (главный)               │
│  ┌─────────────────────────────────────────────────┐│
│  │ ID  │ Наименование                              ││
│  ├─────┼───────────────────────────────────────────┤│
│  │ 1   │ Здание А                                  ││
│  │ 2   │ Здание Б                                  ││
│  │ 3   │ Здание В                                  ││
│  └─────┴───────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────┐
│  Документ "Проемы" (подчиненный)                    │
│  ┌─────────────────────────────────────────────────┐│
│  │ ID  │ devID │ Расположение                      ││
│  ├─────┼───────┼───────────────────────────────────┤│
│  │ 101 │ 1     │ Окно                              ││
│  │ 102 │ 1     │ Дверь                             ││
│  │ 103 │ 2     │ Окно                              ││
│  │ ??? │ 999   │ ????                              ││
│  └─────┴───────┴───────────────────────────────────┘│
│           ↑                                         │
│           └──Этой страницы нет в главном документе! │
└─────────────────────────────────────────────────────┘
```
## Цепочка защиты:
```text

Внешний ключ создает НЕРАЗРЫВНУЮ СВЯЗЬ:
┌──────────────┐
│  Попытка     │
│  вставки     │
│  devID=999   │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  Проверка    │
│  в таблице   │
│  Общие парам.│
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  Есть ID=999?│
└──────┬───────┘
       │
   ┌───┴───┐
   ▼       ▼
  НЕТ      ДА
   │       │
   ▼       ▼
Ошибка  Разрешить
вставку  вставку
```
___
## Что нужно сделать, чтобы вставить запись:
### Вариант 1: Использовать существующий ID
```sql
-- Сначала проверим, какие ID есть
SELECT ID FROM [Общие параметры];  -- показывает: 1,2,3,4,...
-- Потом вставляем с существующим ID
INSERT INTO [Проемы] (devID) VALUES (1);  -- ✅ РАБОТАЕТ!
```
### Вариант 2: Сначала создать в Общие параметры
```sql
-- 1. Создаем новую запись в Общие параметры
INSERT INTO [Общие параметры] ( /* поля */ ) VALUES ( /* значения */ );
-- 2. Получаем её ID
DECLARE @NewID bigint = SCOPE_IDENTITY();
-- 3. Используем этот ID в Проемы
INSERT INTO [Проемы] (devID) VALUES (@NewID);  -- ✅ РАБОТАЕТ!
```
## Это и есть ЦЕЛОСТНОСТЬ ДАННЫХ:
Внешние ключи гарантируют, что в базе **не будет "сирот"** — записей, которые ссылаются на несуществующие данные.
**Твоя догадка была верной!** База данных защищает себя от битых ссылок. 🛡️
___
## Разберем это правило по частям:
```sql
CONSTRAINT FK__Проемы__devID__5B4E756C 
FOREIGN KEY (devID) 
REFERENCES Doodle_x_Angarsk.dbo.[Общие параметры](ID) 
ON DELETE CASCADE
```
### Что каждая часть означает:
```text
┌─────────────────────────────────────────────────────┐
│  CONSTRAINT FK__Проемы__devID__5B4E756C             │
│  ↑                                                  │
│  └─ Имя ограничения (можно было назвать проще,      │
│      например FK_Проемы_ОбщиеПараметры)             │
├─────────────────────────────────────────────────────┤
│  FOREIGN KEY (devID)                                │
│  ↑                                                  │
│  └─ Говорит: "Колонка devID в этой таблице"         │
├─────────────────────────────────────────────────────┤
│REFERENCES Doodle_x_Angarsk.dbo.[Общие параметры](ID)│
│  ↑                          ↑                ↑      │
│  └─ Ссылается на→      База→Схема→Таблица→Колонку   │
├─────────────────────────────────────────────────────┤
│  ON DELETE CASCADE                                  │
│  ↑                                                  │
│  └─ Дополнительное правило:                         │
│      "Если удаляешь родителя - удаляй и детей"      │
└─────────────────────────────────────────────────────┘
```
## Визуализация работы ON DELETE CASCADE:
```text
ДО УДАЛЕНИЯ:
┌────────────────────────────────────────────────────┐
│  Общие параметры              Проемы               │
│  ┌─────┐                      ┌─────┬──────┐       │
│  │ ID  │                      │ ID  │ devID│       │
│  ├─────┤                      ├─────┼──────┤       │
│  │ 1   │←─────────────────────│ 101 │ 1    │       │
│  │ 2   │←──────────┐          │ 102 │ 1    │       │
│  │ 3   │←────┐     └──────────│ 103 │ 2    │       │
│  └─────┘     │      ┌─────────│ 104 │ 3    │       │
│              │      │    ┌────│ 105 │ 1    │       │
│              └──────┼────┼────│ 106 │ 2    │       │
│                     └────┼────│ 107 │ 3    │       │
│                          └─── │ 108 │ 1    │       │
└───────────────────────────────┴─────┴──────┘       │
                              │
                              ▼
┌─────────────────────────────────────────────────────┐
│  УДАЛЯЕМ запись с ID=1 из Общие параметры:          │
│  DELETE FROM [Общие параметры] WHERE ID = 1;        │
└─────────────────────────────────────────────────────┘
                              │
                              ▼
ПОСЛЕ УДАЛЕНИЯ (CASCADE сработал):
┌────────────────────────────────────────────────────┐
│  Общие параметры              Проемы               │
│  ┌─────┐                      ┌─────┬──────┐       │
│  │ ID  │                      │ ID  │ devID│       │
│  ├─────┤                      ├─────┼──────┤       │
│  │ 2   │←──────────┐          │ 103 │ 2    │       │
│  │ 3   │←────┐     └──────────│ 106 │ 2    │       │
│  └─────┘     │                │ 104 │ 3    │       │
│              └────────────────│ 107 │ 3    │       │
│                               └─────┴──────┘       │
│                                                    │
│  Записи с devID=1 (101,102,105,108)                │
│  УДАЛИЛИСЬ АВТОМАТИЧЕСКИ!                          │
└────────────────────────────────────────────────────┘
```
## Альтернативы ON DELETE CASCADE:
```sql
-- 1. Твой вариант: CASCADE
ON DELETE CASCADE  
-- Удалил родителя → удалились все дети
-- 2. Альтернатива: NO ACTION (по умолчанию)
ON DELETE NO ACTION
-- Не даст удалить родителя, пока есть дети
-- Нужно сначала удалить всех детей вручную
-- 3. Альтернатива: SET NULL
ON DELETE SET NULL
-- Удалил родителя → у детей devID стал NULL
-- 4. Альтернатива: SET DEFAULT
ON DELETE SET DEFAULT
-- Удалил родителя → у детей проставилось значение по умолчанию
```
## Сравнение вариантов:
```text
Ситуация: Удаляем здание (ID=1) из Общие параметры
┌─────────────────────────────────────────────────────┐
│  ON DELETE CASCADE    │  ON DELETE NO ACTION        │
│  ┌─────────────────┐  │  ┌─────────────────┐        │
│  │ Здание 1        │  │  │ Здание 1        │        │
│  │ └─ Окно 1       │  │  │ └─ Окно 1       │        │
│  │ └─ Дверь 2      │  │  │ └─ Дверь 2      │        │
│  │ └─ Окно 3       │  │  │ └─ Окно 3       │        │
│  │                 │  │  │                 │        │
│  │ DELETE          │  │  │ DELETE          │        │
│  │ ↓               │  │  │ ↓               │        │
│  │ Всё удалилось!  │  │  │ ОШИБКА!         │        │
│  │                 │  │  │ "Есть дети,     │        │
│  │                 │  │  │  нельзя удалить"│        │
│  └─────────────────┘  │  └─────────────────┘        │
├─────────────────────────────────────────────────────┤
│  ON DELETE SET NULL   │  ON DELETE SET DEFAULT      │
│  ┌─────────────────┐  │  ┌─────────────────┐        │
│  │ Здание 1        │  │  │ Здание 1        │        │
│  │ └─ Окно 1 (NULL)│  │  │ └─ Окно 1 (0)   │        │
│  │ └─ Дверь 2(NULL)│  │  │ └─ Дверь 2 (0)  │        │
│  │ └─ Окно 3 (NULL)│  │  │ └─ Окно 3 (0)   │        │
│  │                 │  │  │                 │        │
│  │ DELETE          │  │  │ DELETE          │        │
│  │ ↓               │  │  │ ↓               │        │
│  │ devID стал NULL │  │  │ devID стал 0    │        │
│  └─────────────────┘  │  └─────────────────┘        │
└─────────────────────────────────────────────────────┘
```
___
### Что произойдет, если попытаться удалить запись из `Общие параметры`, на которую ссылаются записи в `Проемы`?
```sql
DELETE FROM [Общие параметры] WHERE ID = 1;
-- В Проемы есть 5 записей с devID = 1
```

```text
┌─────────────────────────────────────────────────────┐
│  Таблица Проемы (контейнер)                         │
│  ┌─────────────────────────────────────────────────┐│
│  │ До удаления:                                    ││
│  │  ┌─────┬──────┬────────────────┐                ││
│  │  │ ID  │devID │ Расположение   │                ││
│  │  ├─────┼──────┼────────────────┤                ││
│  │  │ 101 │ 1    │ Северная стена │                ││
│  │  │ 102 │ 1    │ Южная стена    │                ││ ← эти удалятся
│  │  │ 103 │ 2    │ Восточная стена│                ││
│  │  │ 104 │ 1    │ Западная стена │                ││ ← эти удалятся
│  │  │ 105 │ 3    │ Кровля         │                ││
│  │  │ 106 │ 1    │ Фундамент      │                ││ ← эти удалятся
│  │  └─────┴──────┴────────────────┘                ││
│  │                                                 ││
│  │ После удаления ID=1 из Общие параметры:         ││
│  │  ┌─────┬──────┬────────────────┐                ││
│  │  │ ID  │devID │ Расположение   │                ││
│  │  ├─────┼──────┼────────────────┤                ││
│  │  │ 103 │ 2    │ Восточная стена│                ││ ← остались
│  │  │ 105 │ 3    │ Кровля         │                ││ ← остались
│  │  └─────┴──────┴────────────────┘                ││
│  └─────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
```
При `ON DELETE CASCADE`:
- **Удаляется** конкретная запись из `Общие параметры`
- **Удаляются** связанные записи из `Проемы`
- **Таблица `Проемы` продолжает существовать** и хранить другие записи
- **Другие записи** в `Проемы` (с другими devID) остаются нетронутыми
**Таблица — это коробка для записей. CASCADE удаляет только конфеты, но не коробку!** 🍬
___
